#!/bin/sh -e

command=`basename ${0}`
diff_option=
parent=`ps -U ${USER} | grep -m 1 -e ${PPID} | grep -oe '[[:graph:]]\+$'`
case ${parent} in
svn)
	diff_option=${1}
	while [ ${2} != -L ]; do diff_option="${diff_option} ${2}"; shift; done
	target1=${6}
	target2=${7}
	parent_is_vcs=true
	;;
git)
	target1=${2}
	target2=${5}
	parent_is_vcs=true
	;;
*)
	target1=${1}
	target2=${2}
	parent_is_vcs= # not set
esac

grep -m 1 -qe '\.\(d\|o\|lo\|html\|jpg\|bdf\|gcda\|gcno\|info\|log\|xml\)$' <<EOF && echo Skipped: "'${target1}'" "'${target2}'" && exit 0
${target1}
${target2}
EOF

detect_multiplexer()
{
	ps -U ${USER} -o pid,ppid,comm | sed -e 1d | awk '
	{
		pids[$1]["ppid"]    = $2
		pids[$1]["command"] = $3
	}
	END{
		for(pid = '${PPID}'; pid != 1; pid = pids[pid]["ppid"]){
			if(pids[pid]["command"] ~ /'${1}':?/){exit 0}
		}
		exit 1
	}'
}

invoke_vim()
{
	which vim > /dev/null || { error_happened=true; return 1;}
	vim --version | grep -m 1 -qe '+clientserver' || {
		echo Error. Vim with "'clientserver'" feature is required, but your Vim does not have the feature... >&2
		error_happened=true
		return 1
	}
	uppercase_1=`echo ${1} | tr a-z A-Z`
	vim --serverlist | grep -m 1 -qie ^${1}\$ || {
		vim_setup_time=1
		detect_multiplexer screen && screen -t ${1} vim --servername ${1} && sleep ${vim_setup_time} && return
		detect_multiplexer tmux && tmux new-window -n ${1} vim --servername ${1} && sleep ${vim_setup_time} && return
	} || {
		cat <<-EOF >&2
		Error. Vim server not found.
		confirm that
		  - Vim server '${uppercase_1}' is running (Try again after to invoke vim '\$ vim --servername ${uppercase_1}' on another tty)
		  - X server is running (X11 forwarding is also enabled if via ssh)
		EOF
		error_happened=true
		return 1
	}
}

detect_filetype()
{
	case `file ${1} | sed -e 's/^[^:]\+: \+\([^ ].\+\)$/\1/'` in
		'Bourne-Again shell script'*) echo sh;;
		'C source'*)                  echo c;;
		'C++ source'*)                echo cpp;;
		'POSIX shell script'*)        echo sh;;
		'Python script'*)             echo python;;
		'Ruby script'*)               echo ruby;;
		*)                            ;;
	esac
}

vim_diff()
{
	error_happened=
	vim_servername=${command}
	trap '[ -n "${parent_is_vcs}" -a -n "${error_happened}" ] && kill ${PPID}' EXIT
	invoke_vim ${vim_servername} || return

	echo ${1} | grep -qe '^/tmp/svn-\|/\.svn/' && { tmp1=`mktemp --tmpdir ${command}.old.XXXXXX`; cp ${1} ${tmp1};}
	echo ${2} | grep -qe '^/tmp/svn-\|/\.svn/' && { tmp2=`mktemp --tmpdir ${command}.new.XXXXXX`; cp ${2} ${tmp2};}
	set ${tmp1:-${1}} ${tmp2:-${2}}
	tmp_vimrc=`mktemp --tmpdir ${command}.vimrc.XXXXXX`
	cat <<EOF > ${tmp_vimrc}
set nocompatible
syntax on
filetype plugin indent on
set splitright
set fillchars=diff:\\ 
set diffopt=filler,vertical
set t_Co=256
" highlight DiffAdd    ctermfg=black ctermbg=lightblue   guifg=black guibg=lightblue
" highlight DiffChange ctermfg=black ctermbg=lightyellow guifg=black guibg=yellow
" highlight DiffDelete               ctermbg=lightred    guifg=white guibg=lightred
" highlight DiffText   ctermfg=white ctermbg=red         guifg=white guibg=red
view `readlink -m ${1}`
diffthis
diffsplit `readlink -m ${2}`
${tmp2:+set filetype=`detect_filetype ${tmp2}`}
let t:filetype = &filetype
wincmd h
let &filetype = t:filetype
wincmd l
windo set nofoldenable
augroup ${command}
	autocmd VimLeave * silent !rm ${tmp_vimrc} ${tmp1} ${tmp2}
augroup END
bdelete /dev/null
EOF
	vim --servername ${vim_servername} --remote-tab +"source ${tmp_vimrc}" /dev/null
}

invoke_diff()
{
	case "${diff_option}" in
	*--orig*)
		diff `echo ${diff_option} | sed -e 's/--orig//'` ${1} ${2};;
	*)
		vim_diff ${1} ${2};;
	esac
}

invoke_diff ${target1} ${target2}
